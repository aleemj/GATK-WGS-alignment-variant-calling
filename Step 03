#PBS -q normal
#PBS -l select=1:ncpus=4:mem=100G
#PBS -l walltime=24:00:00
#PBS -N JointGenotyping
#PBS -P Personal

set -euo pipefail
module load gatk bcftools

REF=/home/users/nus/aleemj/scratch/esativa_alignment_test/ref/eruSat.final.sm.fa
REF_INTERVALS=/home/users/nus/aleemj/scratch/esativa_alignment_test/ref/eruSat.intervals.list #text file with list of scaffolds / chromosomes in ref
VCF_DIR=/home/users/nus/aleemj/scratch/esativa_alignment_test/vcf_files
DB_DIR=/home/users/nus/aleemj/scratch/esativa_alignment_test/genomicsdb
OUT_DIR=/home/users/nus/aleemj/scratch/esativa_alignment_test/joint_vcf
SAMPLE_MAP=$VCF_DIR/sample_map.txt

mkdir -p $OUT_DIR

# Create sample map automatically
rm -f $SAMPLE_MAP

for gvcf in $VCF_DIR/*.g.vcf.gz
do
    sample=$(basename "$gvcf" .g.vcf.gz)
    echo -e "${sample}\t${gvcf}" >> $SAMPLE_MAP
done

gatk GenomicsDBImport \
  --java-options "-Xmx8G" \
  --sample-name-map /home/users/nus/aleemj/scratch/esativa_alignment_test/vcf_files/sample_map.txt \
  --genomicsdb-workspace-path /home/users/nus/aleemj/scratch/esativa_alignment_test/genomicsdb \
  -L $REF_INTERVALS \
  --reader-threads 4

gatk GenotypeGVCFs \
  --java-options "-Xmx8G" \
  -R $REF \
  -V gendb://$DB_DIR \
  -O $OUT_DIR/esativa.raw.vcf.gz
