################ Step 3: Joint Genotyping ################
# Function: This script performs joint genotyping on a set of GVCFs.
# It first creates a sample map from the input GVCFs, imports them 
# into a GenomicsDB workspace using GATK GenomicsDBImport, and then 
# generates a joint VCF using GenotypeGVCFs.
# Parellel runs 10 jobs to speed up process -> chunks

# User should edit the variables at the top:
# REF, INTERVALS_DIR, VCF_DIR, DB_DIR, OUT_DIR, OUT_VCF, PROC_MEM, CHUNKS
# Notes:
# - DB_DIR should be empty for a new GenomicsDB workspace
# - Use --genomicsdb-update-workspace-path to add new samples later
# - REF_INTERVALS should be a line-separated list of scaffolds/chromosomes

#!/bin/bash
# Configuration
REF=<USER INPUT>
SAMPLE_MAP=<USER INPUT>
INTERVAL_LIST=<USER INPUT>
INTERVALS_OUT=<USER INPUT>
DB_BASE=<USER INPUT>
VCF_OUT=<USER INPUT>
CHUNKS=<USER INPUT>

mkdir -p jobs logs "$VCF_OUT" "$INTERVALS_OUT" "$DB_BASE"

# 1. Split the genome into 100 chunks
gatk SplitIntervals -R "$REF" -L "$INTERVAL_LIST" --scatter-count $CHUNKS -O "$INTERVALS_OUT"

# 2. Generate 100 PBS scripts
for i in $(seq 0 $((CHUNKS-1)))
do
    CHUNK_ID=$(printf "%04d" $i)
    SCRIPT="jobs/run_gatk_${CHUNK_ID}.sh"

    cat <<EOT > $SCRIPT
#!/bin/bash
#PBS -q normal
#PBS -l select=1:ncpus=2:mem=100G
#PBS -l walltime=72:00:00
#PBS -N JointGenotyping_${CHUNK_ID}
#PBS -e logs/${CHUNK_ID}.err
#PBS -o logs/${CHUNK_ID}.out

cd \$PBS_O_WORKDIR

# Clean up existing workspace to avoid "Error creating GenomicsDB workspace"
rm -rf ${DB_BASE}/db_chunk_${CHUNK_ID}

# GenomicsDB Import
# Using 16G Heap to leave massive room for C++ native memory
gatk --java-options "-Xmx16G" GenomicsDBImport \\
    --genomicsdb-workspace-path ${DB_BASE}/db_chunk_${CHUNK_ID} \\
    --batch-size 50 \\
    -L ${INTERVALS_OUT}/${CHUNK_ID}-scattered.interval_list \\
    --sample-name-map ${SAMPLE_MAP} \\
    --reader-threads 2

# GenotypeGVCFs
# Using 48G Heap - the remaining 52G (out of 100G) is for GenomicsDB overhead
gatk --java-options "-Xmx48G" GenotypeGVCFs \\
    -R ${REF} \\
    -V gendb://${DB_BASE}/db_chunk_${CHUNK_ID} \\
    -O ${VCF_OUT}/part_${CHUNK_ID}.vcf.gz \\
EOT

    chmod +x $SCRIPT
done

echo "Success: Created 100 jobs in 'jobs/' folder."

#submit all the scripts 
#for script in jobs/*.sh; do qsub $script; done
